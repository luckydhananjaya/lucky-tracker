<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client - Blueprint Mvmnt</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-blue-600 text-white p-6 font-sans">
    <div class="max-w-md mx-auto">
        
        <div class="flex flex-col items-center mb-6 pt-4">
            <img src="/icon.png" alt="Logo" class="w-16 h-16 rounded-xl shadow-lg mb-2">
            <p class="text-blue-200 text-xs font-bold tracking-widest uppercase">Blueprint Mvmnt</p>
        </div>

        <div class="bg-white rounded-[2.5rem] p-8 text-center shadow-2xl text-gray-900 mb-6 relative overflow-hidden">
            
            <div id="alertBanner" class="hidden absolute top-0 left-0 w-full p-3 text-white text-xs font-bold uppercase tracking-widest">
                </div>

            <p id="clientGreeting" class="text-blue-500 font-bold uppercase text-[10px] mb-2 tracking-widest text-center w-full mt-4">Welcome</p>
            
            <h2 class="text-8xl font-black my-4 text-blue-600" id="balance">--</h2>
            <p class="text-gray-400 text-xs font-bold uppercase mb-2">Sessions Left</p>
            
            <p id="expiryDisplay" class="text-gray-400 text-[10px] font-bold uppercase mb-6 hidden">
                Valid Until: <span id="expiryDate" class="text-gray-600">--</span>
            </p>
            
            <div class="space-y-3">
                <input id="userName" type="text" placeholder="Your Name (Optional)" class="w-full border-2 border-gray-100 p-4 rounded-2xl text-center outline-none focus:border-blue-500 bg-gray-50 text-gray-900 transition-all">
                <input id="userEmail" type="email" placeholder="Your Email" class="w-full border-2 border-gray-100 p-4 rounded-2xl text-center outline-none focus:border-blue-500 bg-gray-50 text-gray-900 transition-all">
            </div>
            
            <button onclick="fetchBalance()" class="mt-4 text-blue-500 font-bold text-sm hover:underline py-2">Check My Status</button>
        </div>

        <div id="scanner-container" class="hidden fixed inset-0 bg-black z-50 p-6 flex flex-col justify-center">
            <div id="reader" class="rounded-3xl overflow-hidden border-4 border-blue-500"></div>
            <button onclick="stopScanner()" class="mt-10 text-white font-bold bg-red-500 p-5 rounded-2xl">Cancel Scan</button>
        </div>

        <button onclick="startScanner()" class="w-full bg-gray-900 py-6 rounded-[2.5rem] font-black text-xl shadow-xl active:scale-95 transition-all uppercase tracking-widest">
            SCAN
        </button>
    </div>

    <script>
        // 1. SETUP SUPABASE
        const supabaseUrl = 'https://umgeykseoqfwrkuttnxm.supabase.co';
        
        // --- PASTE YOUR ANON KEY BELOW ---
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtZ2V5a3Nlb3Fmd3JrdXR0bnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDI3NTYsImV4cCI6MjA4NTUxODc1Nn0.vUDnlgdARv7v0wq98qS1dXTbPKtXfCy0EZy7wfP3hCk'; 
        // ---------------------------------

        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);
        let html5QrCode;

        async function fetchBalance() {
            const emailInput = document.getElementById('userEmail').value.toLowerCase().trim();
            const nameInput = document.getElementById('userName').value.trim();
            const banner = document.getElementById('alertBanner');

            if (!emailInput) return alert("Please enter your email!");

            // Reset UI
            banner.classList.add('hidden');
            document.getElementById('expiryDisplay').classList.add('hidden');

            // 1. Fetch Data
            const { data, error } = await _supabase
                .from('client_profiles')
                .select('client_name, total_sessions, sessions_used, expiry_date')
                .eq('email', emailInput)
                .single();

            if (error || !data) { alert("Account not found!"); return; }

            // 2. Update Name if needed
            if (nameInput && nameInput !== data.client_name) {
                await _supabase.from('client_profiles').update({ client_name: nameInput }).eq('email', emailInput);
                document.getElementById('clientGreeting').innerText = `Welcome, ${nameInput}`;
            } else {
                document.getElementById('clientGreeting').innerText = `Welcome, ${data.client_name || nameInput || "Client"}`;
                if (!nameInput && data.client_name) document.getElementById('userName').value = data.client_name;
            }

            // 3. Update Balance
            document.getElementById('balance').innerText = data.total_sessions - data.sessions_used;

            // 4. Check Expiry Logic
            if (data.expiry_date) {
                const expiry = new Date(data.expiry_date);
                const today = new Date();
                
                // Calculate difference in days
                const diffTime = expiry - today; 
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                document.getElementById('expiryDisplay').classList.remove('hidden');
                document.getElementById('expiryDate').innerText = data.expiry_date;

                // ALERT LOGIC
                if (diffDays < 0) {
                    // EXPIRED
                    banner.innerText = "PACKAGE EXPIRED";
                    banner.className = "absolute top-0 left-0 w-full p-3 text-white text-xs font-bold uppercase tracking-widest bg-gray-800";
                    banner.classList.remove('hidden');
                } 
                else if (diffDays <= 3) {
                    // CRITICAL (3 Days left)
                    banner.innerText = `EXPIRING SOON (${diffDays} DAYS LEFT)`;
                    banner.className = "absolute top-0 left-0 w-full p-3 text-white text-xs font-bold uppercase tracking-widest bg-red-500 animate-pulse";
                    banner.classList.remove('hidden');
                } 
                else if (diffDays <= 7) {
                    // WARNING (7 Days left)
                    banner.innerText = "EXPIRING IN 1 WEEK";
                    banner.className = "absolute top-0 left-0 w-full p-3 text-white text-xs font-bold uppercase tracking-widest bg-orange-500";
                    banner.classList.remove('hidden');
                }
            }
        }

        async function startScanner() {
            const email = document.getElementById('userEmail').value;
            if(!email) return alert("Enter email first!");
            document.getElementById('scanner-container').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                if (decodedText === "Lucky_session_Tracker") { handleCheckIn(email.toLowerCase().trim()); stopScanner(); }
            });
        }

        function stopScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-container').classList.add('hidden')).catch(() => {});
            else document.getElementById('scanner-container').classList.add('hidden');
        }

        async function handleCheckIn(email) {
            const { error } = await _supabase.rpc('check_in_client', { target_email: email });
            if (!error) {
                alert("Check-in Successful! Enjoy your session."); 
                fetchBalance(); 
            } else {
                alert("Check-in Failed: " + error.message); 
            }
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>
